<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Debug Markdown Trigger</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #editor { border: 1px solid #ccc; min-height: 200px; padding: 10px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; font-family: monospace; }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>Live Debug - Markdown Trigger</h1>
    <p>Type markdown triggers like <code># </code>, <code>- </code>, <code>* </code>, <code>1. </code> in the editor below:</p>
    
    <div id="editor"></div>
    <div id="log"></div>

    <script type="module">
        import { Editor } from './src/index.js';

        const log = document.getElementById('log');
        
        function addLog(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        // Override the checkAndConvertBlock method to add debugging
        const originalCheckAndConvertBlock = Editor.prototype.checkAndConvertBlock;
        Editor.prototype.checkAndConvertBlock = function(block) {
            const element = block.getElement();
            const innerHTML = element.innerHTML;
            
            addLog(`checkAndConvertBlock called with innerHTML: "${innerHTML}"`);
            
            // Get the exact processing logic
            const rawText = this.utils.stripTags(innerHTML);
            addLog(`rawText after stripTags: "${rawText}"`);
            
            const normalizedText = rawText.replace(/&nbsp;/g, ' ').replace(/\u00A0|\xA0|\u00a0/g, ' ');
            addLog(`normalizedText: "${normalizedText}"`);
            
            const textContent = normalizedText.replace(/^\s+/, '');
            addLog(`textContent after trim: "${textContent}"`);
            
            const isEmpty = !textContent;
            addLog(`isEmpty check: ${isEmpty}`, isEmpty ? 'error' : 'success');
            
            if (isEmpty) {
                addLog('âŒ BLOCKED by empty check - conversion skipped', 'error');
                return false;
            }
            
            const result = originalCheckAndConvertBlock.call(this, block);
            addLog(`checkAndConvertBlock result: ${result}`, result ? 'success' : 'info');
            
            return result;
        };

        // Override convertBlockType to add debugging
        const originalConvertBlockType = Editor.prototype.convertBlockType;
        Editor.prototype.convertBlockType = function(block, newBlockType, remainingContent) {
            addLog(`convertBlockType called: ${block.getType()} -> ${newBlockType}, remaining: "${remainingContent}"`);
            const result = originalConvertBlockType.call(this, block, newBlockType, remainingContent);
            addLog(`convertBlockType result: ${result}`, result ? 'success' : 'error');
            return result;
        };

        // Initialize editor
        const editor = new Editor({
            containerId: 'editor',
            placeholder: 'Type markdown triggers like # for heading...'
        });

        addLog('Editor initialized. Start typing markdown triggers!', 'success');
    </script>
</body>
</html>
