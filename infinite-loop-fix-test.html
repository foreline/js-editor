<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infinite Loop Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .editor {
            border: 1px solid #ccc;
            min-height: 200px;
            padding: 10px;
            margin: 20px 0;
        }
        
        .block {
            margin: 10px 0;
            padding: 5px;
            border-left: 3px solid transparent;
        }
        
        .active-block {
            border-left-color: #007bff;
            background-color: #f8f9fa;
        }
        
        #console-output {
            background-color: #f4f4f4;
            border: 1px solid #ddd;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        button {
            margin: 5px;
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <h1>Infinite Loop Fix Test</h1>
    <p>This page tests the fix for the "Endless methods call when clearing the editor" issue.</p>
    
    <div id="test-buttons">
        <button onclick="clearEditor()">Clear Editor (Test Fix)</button>
        <button onclick="selectAllAndDelete()">Select All & Delete (Test Fix)</button>
        <button onclick="clearConsole()">Clear Console Output</button>
    </div>
    
    <div id="editor" class="editor" contenteditable="true">
        <div class="block block-p" data-block-type="p">
            This is a test paragraph. Try clearing the editor using the buttons above.
        </div>
        <div class="block block-p" data-block-type="p">
            This is another paragraph. The fix should prevent infinite loops when the editor is cleared.
        </div>
    </div>
    
    <h3>Console Output Monitor:</h3>
    <div id="console-output"></div>
    
    <script type="module">
        // Mock the editor functionality for testing
        class TestEditor {
            constructor(element) {
                this.instance = element;
                this.currentBlock = null;
                this.updateCount = 0;
                this.ensureDefaultBlockCount = 0;
            }
            
            update() {
                this.updateCount++;
                this.log(`Editor.update() called (${this.updateCount})`);
                
                // Simulate the original buggy behavior vs fixed behavior
                const isEmpty = this.isEditorEmpty();
                if (isEmpty) {
                    // In the original code, this would call update() again causing infinite loop
                    // In the fixed code, it doesn't call update()
                    this.ensureDefaultBlock();
                }
                
                return this;
            }
            
            ensureDefaultBlock() {
                this.ensureDefaultBlockCount++;
                this.log(`Editor.ensureDefaultBlock() called (${this.ensureDefaultBlockCount})`);
                
                // Fixed behavior: DO NOT call this.update() here
                // Original buggy behavior would be: this.update();
                
                // Create default block if needed
                const blocks = this.instance.querySelectorAll('.block');
                if (blocks.length === 0) {
                    this.addEmptyBlock();
                }
                
                // Note: No this.update() call here anymore - this is the fix!
                return this;
            }
            
            addEmptyBlock() {
                this.log('Editor.addEmptyBlock() called');
                
                const block = document.createElement('div');
                block.className = 'block block-p active-block';
                block.setAttribute('data-block-type', 'p');
                block.innerHTML = '<br>';
                
                this.instance.appendChild(block);
                this.currentBlock = block;
                
                return block;
            }
            
            isEditorEmpty() {
                const blocks = this.instance.querySelectorAll('.block');
                if (blocks.length === 0) return true;
                
                for (let block of blocks) {
                    const text = block.textContent.trim();
                    if (text.length > 0) return false;
                }
                return true;
            }
            
            log(message) {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = `[${timestamp}] ${message}`;
                console.log(logEntry);
                
                // Also display in the page
                const consoleOutput = document.getElementById('console-output');
                const logElement = document.createElement('div');
                logElement.textContent = logEntry;
                consoleOutput.appendChild(logElement);
                consoleOutput.scrollTop = consoleOutput.scrollHeight;
                
                // Prevent infinite loops by limiting calls
                if (this.updateCount > 5 || this.ensureDefaultBlockCount > 3) {
                    this.log('⚠️ INFINITE LOOP DETECTED - Stopping execution');
                    throw new Error('Infinite loop detected');
                }
            }
        }
        
        // Initialize the test editor
        const editorElement = document.getElementById('editor');
        const testEditor = new TestEditor(editorElement);
        
        // Global functions for button clicks
        window.clearEditor = function() {
            testEditor.log('=== CLEARING EDITOR ===');
            testEditor.updateCount = 0;
            testEditor.ensureDefaultBlockCount = 0;
            
            // Clear the editor content
            editorElement.innerHTML = '';
            
            // Trigger update (this would cause infinite loop in original code)
            try {
                testEditor.update();
                testEditor.log('✅ SUCCESS: No infinite loop detected!');
            } catch (error) {
                testEditor.log(`❌ ERROR: ${error.message}`);
            }
        };
        
        window.selectAllAndDelete = function() {
            testEditor.log('=== SELECT ALL & DELETE ===');
            testEditor.updateCount = 0;
            testEditor.ensureDefaultBlockCount = 0;
            
            // Simulate selecting all content and deleting
            const blocks = editorElement.querySelectorAll('.block');
            blocks.forEach(block => block.textContent = '');
            
            try {
                testEditor.update();
                testEditor.log('✅ SUCCESS: No infinite loop detected!');
            } catch (error) {
                testEditor.log(`❌ ERROR: ${error.message}`);
            }
        };
        
        window.clearConsole = function() {
            document.getElementById('console-output').innerHTML = '';
        };
        
        // Initial log
        testEditor.log('Test editor initialized. Ready to test infinite loop fix.');
    </script>
</body>
</html>
